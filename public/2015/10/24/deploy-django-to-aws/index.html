<!DOCTYPE html>
<html>
<head>
	<!-- Google Tag Manager -->
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-KNQM2VC');</script>
	<!-- End Google Tag Manager -->

	<title>Connor Leech</title>

	<!-- Meta -->
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- Favicon -->
	<link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">

	<!-- Bootstrap -->
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
	
	<!-- Fonts -->
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
	<link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

	<!-- Custom -->
	<link rel='stylesheet' href='css/theme.css'>
	<style>
	  .navbar-toggler {
	    z-index: 1;
	  }
	  @media (max-width: 576px) {
	    nav > .container {
	      width: 100%;
	    }
	  }
	  </style>
</head>
<body id='wrapper'>
	<!-- Navigation -->
<nav class="navbar fixed-top navbar-toggleable-md navbar-light is-fixed" id="mainNav">
  <div class="container">
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu <i class="fa fa-bars"></i>
    </button>
    <a class="navbar-brand page-scroll" href="/">Connor Leech</a>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
        	<a class="nav-link page-scroll" href="/blog">Blog</a>
        	<a class="nav-link page-scroll" href="/work">Work</a>
        	<a class="nav-link page-scroll" href="/about">About</a>
        	<a class="nav-link page-scroll" href="/contact">Contact</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
	<div class='container blog-post'>
	<div class='row'>
		<div class='col-sm-12'>
			<a href='/' class="btn btn-yellow btn-circle" style='color:grey;'>
            	<i class="fa fa-home fa-2"></i>
        	</a>
		</div>
	</div>
	<div class='row'>
		<h1 class='author-name'>deploy django to aws</h1>
	    October 24, 2015 
	    <hr />
		<p>Following this <a href="https://realpython.com/blog/python/deploying-a-django-app-to-aws-elastic-beanstalk/" target="_blank" rel="external">tutorial</a>.</p>
<a id="more"></a>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/realpython/image-of-the-day.git</span></div><div class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> image-of-the-day</span></div><div class="line"><span class="meta">$</span><span class="bash"> mkvirtualenv cptmusicblog</span></div><div class="line"><span class="meta">$</span><span class="bash"> pip install -r requirements.txt</span></div></pre></td></tr></table></figure>
<p>If the database is not running run:<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ postgres -D /usr/local/var/postgres</div><div class="line">$ psql postgres</div><div class="line">postgres=<span class="comment"># create database cptmusicblog;</span></div><div class="line">postgres=<span class="comment"># \l</span></div></pre></td></tr></table></figure></p>
<p>You should see a database named <code>cptmusicblog</code> in the output. <code>control + D</code> stops the postgres on Mac.</p>
<p>Modify <code>iotd/iotd/settings.py</code> to your local database settings:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> <span class="string">'RDS_DB_NAME'</span> <span class="keyword">in</span> os<span class="selector-class">.environ</span>:</div><div class="line">    DATABASES = &#123;</div><div class="line">       <span class="string">'default'</span>: &#123;</div><div class="line">             <span class="string">'ENGINE'</span>:<span class="string">'django.db.backends.postgresql_psycopg2'</span>,</div><div class="line">             <span class="string">'NAME'</span>: os<span class="selector-class">.environ</span>[<span class="string">'RDS_DB_NAME'</span>],</div><div class="line">             <span class="string">'USER'</span>: os<span class="selector-class">.environ</span>[<span class="string">'RDS_USERNAME'</span>],</div><div class="line">             <span class="string">'PASSWORD'</span>: os<span class="selector-class">.environ</span>[<span class="string">'RDS_PASSWORD'</span>],</div><div class="line">             <span class="string">'HOST'</span>: os<span class="selector-class">.environ</span>[<span class="string">'RDS_HOSTNAME'</span>],</div><div class="line">             <span class="string">'PORT'</span>: os<span class="selector-class">.environ</span>[<span class="string">'RDS_PORT'</span>],</div><div class="line">             &#125;</div><div class="line">          &#125;</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    DATABASES = &#123;</div><div class="line">        <span class="string">'default'</span>: &#123;</div><div class="line">            <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.postgresql_psycopg2'</span>,</div><div class="line">            <span class="string">'NAME'</span>: <span class="string">'cptmusicblog'</span>,</div><div class="line">            <span class="string">'USER'</span>: <span class="string">''</span>,</div><div class="line">            <span class="string">'PASSWORD'</span>: <span class="string">''</span>,</div><div class="line">            <span class="string">'HOST'</span> : <span class="string">'localhost'</span>,</div><div class="line">            <span class="string">'PORT'</span> : <span class="string">'5432'</span>,</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>Run some django commands to set up the database and create an admin user. The credentials you choose will allow you to log in to the admin section of the site.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> python manage.py migrate</span></div><div class="line"><span class="meta">$</span><span class="bash"> python manage.py createsuperuser</span></div><div class="line"><span class="meta">$</span><span class="bash"> python manage.py runserver</span></div></pre></td></tr></table></figure>
<p>Go to <code>http://localhost:8000/admin/</code> and log in with credentials. If you go to the root (<code>http://localhost:8000/</code>) you will see a django error. Now go add an image in the admin section under “Featured images”. Once you upload you’ll see your image on the homepage <code>/</code>.</p>
<p><img src="/content/images/2015/06/Screen-Shot-2015-06-18-at-11-26-12-AM.png" alt=""></p>
<h3 id="CLI-for-AWS-Elastic-Beanstalk"><a href="#CLI-for-AWS-Elastic-Beanstalk" class="headerlink" title="CLI for AWS Elastic Beanstalk"></a>CLI for AWS Elastic Beanstalk</h3><p>Install this to your virtualenv:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> pip install awsebcli</span></div><div class="line"><span class="meta">$</span><span class="bash"> eb --version</span></div></pre></td></tr></table></figure>
<p>Then sign in to <a href="http://aws.amazon.com/" target="_blank" rel="external">AWS</a>:</p>
<p><img src="/content/images/2015/06/Screen-Shot-2015-06-18-at-11-32-00-AM.png" alt=""></p>
<p>Okay then set up an elastic beanstalk environment:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> eb init</span></div></pre></td></tr></table></figure>
<p><img src="/content/images/2015/06/Screen-Shot-2015-06-18-at-11-35-51-AM.png" alt=""></p>
<p><img src="/content/images/2015/06/Screen-Shot-2015-06-18-at-11-38-50-AM.png" alt=""></p>
<p>I created a new ssh key for this named aws-eb. Once that command is done there is now a <code>.elasticbeanstalk</code> directory in your project.</p>
<p>Run <code>$ eb console</code> and your browser will open up</p>
<h3 id="Gif-break"><a href="#Gif-break" class="headerlink" title="Gif break"></a>Gif break</h3><p>This is us right now:</p>
<p><img src="http://media.giphy.com/media/vgxBQVRkJ5YBO/giphy.gif" alt=""></p>
<p>This is where we want to be: </p>
<p><img src="http://media.giphy.com/media/rjLBUukT0w1AA/giphy.gif" alt=""></p>
<p>This is going to happen first:</p>
<p><img src="http://media.giphy.com/media/X5nQfDQnaTSvu/giphy.gif" alt=""></p>
<p>Don’t do this:</p>
<p><img src="http://media.giphy.com/media/2yU3Ex75PRjeE/giphy.gif" alt=""></p>
<h3 id="Configure-environment"><a href="#Configure-environment" class="headerlink" title="Configure environment"></a>Configure environment</h3><p>We want to have a development and production environment.</p>
<p>Run <code>$ eb create</code></p>
<p><img src="/content/images/2015/06/Screen-Shot-2015-06-18-at-11-47-54-AM.png" alt=""></p>
<p>So that looks good. We want to host our static files in an S3 bucket.</p>
<p>Elastic beanstalk created an environment and tried to deploy our app…</p>
<p>In the console (<code>eb console</code>) you can view the environment:</p>
<p><img src="/content/images/2015/06/Screen-Shot-2015-06-18-at-11-50-59-AM.png" alt=""></p>
<p>Now create a database in the AWS console:</p>
<ol>
<li>Click the “Configuration” link.</li>
<li>Scroll all the way to the bottom of the page, and then under the “Data Tier” section, click the link “create a new RDS database”.</li>
<li>On the RDS setup page change the “DB Engine” to “postgres”.</li>
<li>Add a “Master Username” and “Master Password”.</li>
<li>Save the changes</li>
</ol>
<p>I saw this for a while:</p>
<p><img src="/content/images/2015/06/loading-1.gif" alt=""></p>
<p>Create <code>.ebextensions/01_packages.config</code>:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">packages</span>:</div><div class="line">  <span class="attribute">yum</span>:</div><div class="line">    <span class="attribute">git</span>: []</div><div class="line">    <span class="attribute">postgresql93-devel</span>: []</div></pre></td></tr></table></figure>
<h3 id="Fix-mistrake"><a href="#Fix-mistrake" class="headerlink" title="Fix mistrake"></a>Fix mistrake</h3><p>Actually <code>.elasticbeanstalk</code> goes in the root of the directory, so we have to move it, so from the <code>iotd</code> directory (where it is and not supposed to be).</p>
<p>Move the file:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ mv .elasticbeanstalk <span class="built_in">..</span>   </div><div class="line">$ cd <span class="built_in">..</span></div><div class="line">$ eb list</div><div class="line">$ eb<span class="built_in"> config </span>cptmusicblog-dev</div></pre></td></tr></table></figure></p>
<h3 id="change-WSGIPath-config"><a href="#change-WSGIPath-config" class="headerlink" title="change WSGIPath config"></a>change WSGIPath config</h3><p>This pulls down a config file from AWS. After we edit the config the app will redeploy. We have to edit this part of the file:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="string">aws:</span><span class="string">elasticbeanstalk:</span><span class="string">container:</span><span class="string">python:</span></div><div class="line"><span class="symbol">  NumProcesses:</span> <span class="string">'1'</span></div><div class="line"><span class="symbol">  NumThreads:</span> <span class="string">'15'</span></div><div class="line"><span class="symbol">  StaticFiles:</span> <span class="regexp">/static/</span>=<span class="keyword">static</span>/</div><div class="line"><span class="symbol">  WSGIPath:</span> application.py</div></pre></td></tr></table></figure>
<p>Change the last line so that it reads:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="string">aws:</span><span class="string">elasticbeanstalk:</span><span class="string">container:</span><span class="string">python:</span></div><div class="line"><span class="symbol">  NumProcesses:</span> <span class="string">'1'</span></div><div class="line"><span class="symbol">  NumThreads:</span> <span class="string">'15'</span></div><div class="line"><span class="symbol">  StaticFiles:</span> <span class="regexp">/static/</span>=<span class="keyword">static</span>/</div><div class="line"><span class="symbol">  WSGIPath:</span> iotd<span class="regexp">/iotd/</span>wsgi.py</div></pre></td></tr></table></figure>
<p>Then run <code>$ eb deploy</code> after you save and exit the changes.</p>
<p>You can now go to the website (<a href="http://cptmusicblog-dev.elasticbeanstalk.com/" target="_blank" rel="external">http://cptmusicblog-dev.elasticbeanstalk.com/</a> in my case) and see a nice friendly django error:</p>
<p><img src="/content/images/2015/06/Screen-Shot-2015-06-18-at-1-05-32-PM.png" alt=""></p>
<p>This is good! We got the same thing when running locally before we uploaded the doge image. Go to <code>&lt;your_eb_url&gt;/admin</code> (so in my case <code>http://cptmusicblog-dev.elasticbeanstalk.com/admin</code>) and you will see the django admin login panel. Hooray!!</p>
<h3 id="Logging-in-to-the-admin"><a href="#Logging-in-to-the-admin" class="headerlink" title="Logging in to the admin"></a>Logging in to the admin</h3><p>In <code>.elasticbeanstalk/02_python.config</code> we specify settings for AWS:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">container_commands</span>:</div><div class="line">    <span class="number">01</span><span class="attribute">_migrate</span>:</div><div class="line">	    <span class="attribute">command</span>: <span class="string">"source /opt/python/run/venv/bin/activate &amp;&amp; python iotd/manage.py migrate --noinput"</span></div><div class="line">	    <span class="attribute">leader_only</span>: true</div><div class="line">    <span class="number">02</span><span class="attribute">_createsu</span>:</div><div class="line">	  <span class="attribute">command</span>: <span class="string">"source /opt/python/run/venv/bin/activate &amp;&amp; python iotd/manage.py createsu"</span></div><div class="line">	  <span class="attribute">leader_only</span>: true</div><div class="line">    <span class="number">03</span><span class="attribute">_collectstatic</span>:</div><div class="line">	  <span class="attribute">command</span>: <span class="string">"source /opt/python/run/venv/bin/activate &amp;&amp; python iotd/manage.py collectstatic --noinput"</span></div><div class="line"></div><div class="line"><span class="attribute">option_settings</span>:</div><div class="line">    <span class="string">"aws:elasticbeanstalk:application:environment"</span>:</div><div class="line">        <span class="attribute">DJANGO_SETTINGS_MODULE</span>: <span class="string">"iotd.settings"</span></div><div class="line">        <span class="string">"PYTHONPATH"</span>: <span class="string">"/opt/python/current/app/iotd:$PYTHONPATH"</span></div><div class="line">        <span class="string">"ALLOWED_HOSTS"</span>: <span class="string">".elasticbeanstalk.com"</span></div><div class="line">    <span class="string">"aws:elasticbeanstalk:container:python"</span>:</div><div class="line">        <span class="attribute">WSGIPath</span>: iotd/iotd/wsgi.py</div><div class="line">        <span class="attribute">NumProcesses</span>: <span class="number">3</span></div><div class="line">        <span class="attribute">NumThreads</span>: <span class="number">20</span></div><div class="line">    <span class="string">"aws:elasticbeanstalk:container:python:staticfiles"</span>:</div><div class="line">        <span class="string">"/static/"</span>: <span class="string">"www/static/"</span></div></pre></td></tr></table></figure>
<p>Notice the second step creates a superuser. The directory we cloned has a script in <code>iotd/images/management/commands/createsu.py</code>:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">import os</div><div class="line"></div><div class="line"><span class="keyword">from</span> django.core.management.base import BaseCommand</div><div class="line"><span class="keyword">from</span> django.contrib.auth.models import<span class="built_in"> User</span></div><div class="line"></div><div class="line">class Command(BaseCommand):</div><div class="line"></div><div class="line">    def handle(self, <span class="number">*a</span>rgs, **options):</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> User.objects.filter(<span class="attribute">username</span>=<span class="string">"admin"</span>).exists():</div><div class="line">            User.objects.create_superuser(<span class="string">"admin"</span>, <span class="string">"admin@admin.com"</span>, <span class="string">"admin"</span>)</div></pre></td></tr></table></figure>
<p>So when you go to <code>/admin</code> log in with <code>username: admin, password: admin</code>. Then you can upload an image and you will see doge again!</p>
<p><img src="/content/images/2015/06/Screen-Shot-2015-06-18-at-1-27-39-PM.png" alt=""></p>
<h3 id="Changing-where-the-images-are-hosted"><a href="#Changing-where-the-images-are-hosted" class="headerlink" title="Changing where the images are hosted"></a>Changing where the images are hosted</h3><p>So we are almost good. The problem now is that the images are hosted on the EC2 instance itself in the static files directory. We don’t want that. Every time we run <code>eb deploy</code> we will create a brand new instance with a clean static files directory. We don’t want to wipe our data every single time we deploy. </p>
<p>Instead we will to host our data in an <a href="http://aws.amazon.com/s3/" target="_blank" rel="external">S3 bucket</a>. The instances will talk to the bucket and render the data. That way we can deploy all day long and not erase the data we’ve uploded.</p>
<p>Try it! Run <code>eb deploy</code> and the image will disappear:</p>
<p><img src="/content/images/2015/06/Screen-Shot-2015-06-18-at-1-40-09-PM.png" alt=""></p>
<p>The text will be stored in the database we set up but the static_files will be wiped.</p>
<h3 id="Gif-break-2"><a href="#Gif-break-2" class="headerlink" title="Gif break #2"></a>Gif break #2</h3><p>This is us if we host our images on EC2 instances instead of S3 buckets:</p>
<p><img src="http://media.giphy.com/media/zemslkaIiA2oE/giphy.gif" alt=""></p>
<p>I will continue on how to set up and configure S3 bucket for our app in part 2:</p>
<p><a href="http://connorleech.ghost.io/deploy-django-to-aws-part-2-hosting-files-on-s3/" target="_blank" rel="external">deploy django to aws part 2: hosting files on S3</a></p>
<p>If you don’t need file upload and only a server and a database you are good to go. Otherwise see you “after the jump”.</p>

	</div>
</div>
	
</body>
</html>