<!DOCTYPE html>
<html>
<head>
	<!-- Google Tag Manager -->
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-KNQM2VC');</script>
	<!-- End Google Tag Manager -->

	<title>Connor Leech</title>

	<!-- Meta -->
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- Favicon -->
	<link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">

	<!-- Fonts -->
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
	<link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

	<!-- Bootstrap -->
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
	<link rel='stylesheet' href='css/readable.bootswatch.css'>
	<link rel='stylesheet' href='css/main.css'>

</head>
<body id='wrapper'>
	<div class='container blog-post'>
	<div class='row'>
		<div class='col-sm-12'>
			<a href='/' class="btn btn-yellow btn-circle" style='color:grey;'>
            	<i class="fa fa-home fa-2"></i>
        	</a>
		</div>
	</div>
	<div class='row'>
		<h1 class='author-name'>Build a blog with the MEAN stack (part 1)</h1>
	    October 24, 2015 
	    <hr />
		<p>I’m posting a blog post on how to make a blog. So meta.</p>
<p><img src="http://media.giphy.com/media/roLxlT1nPN8GI/giphy.gif" alt=""></p>
<p>Check out the <a href="https://github.com/cleechtech/mean-blog" target="_blank" rel="external">SOURCE CODE</a></p>
<a id="more"></a>
<h4 id="Get-crackin"><a href="#Get-crackin" class="headerlink" title="Get crackin"></a>Get crackin</h4><p>Install the starter template and change the names, delete the silly image in the README.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> git@github.com:jasonshark/mean-starter.git</span></div><div class="line"><span class="meta">$</span><span class="bash"> mv mean-starter mean-blog &amp;&amp; <span class="built_in">cd</span> mean-blog</span></div><div class="line"><span class="meta">$</span><span class="bash"> npm install</span></div><div class="line"><span class="meta">$</span><span class="bash"> node server</span></div></pre></td></tr></table></figure>
<p><em>Tip:</em> install nodemon <code>$ npm install nodemon -g</code> and you won’t have to refresh the page all the time</p>
<h4 id="Render-admin-login"><a href="#Render-admin-login" class="headerlink" title="Render admin login"></a>Render admin login</h4><p>There are lots of ways to handle authentication within the meanstack. We’re going to use <a href="http://passportjs.org/" target="_blank" rel="external">Passport.js</a>, the express server and ejs templates. The angular will come in handy once the template is already rendered.</p>
<p>First define our basic routes for the login and register pages. These go in <strong>server/routes.js</strong>.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">app.<span class="keyword">use</span>(<span class="string">'/api'</span>, apiRouter);	<span class="comment">// haven't built any api yet</span></div><div class="line">	app.<span class="keyword">use</span>(<span class="string">'/'</span>, router);</div><div class="line"></div><div class="line">	<span class="comment">// home route</span></div><div class="line">	router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>&#123;</div><div class="line">		res.render(<span class="string">'index'</span>);</div><div class="line">	&#125;);</div><div class="line"></div><div class="line">	<span class="comment">// admin route</span></div><div class="line">	router.get(<span class="string">'/admin'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>&#123;</div><div class="line">		res.render(<span class="string">'admin/login'</span>);</div><div class="line">	&#125;);</div><div class="line"></div><div class="line">	router.get(<span class="string">'/admin/register'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>&#123;</div><div class="line">		res.render(<span class="string">'admin/register'</span>);</div><div class="line">	&#125;);</div></pre></td></tr></table></figure>
<p>Now let’s set up the views. We are going to add the ejs template engine and store the views in a new folder called views. First we’ll configure the server to render ejs templates. Add this to the <strong>server.js</strong> express config block:</p>
<p><code>app.set(&#39;view engine&#39;, &#39;ejs&#39;);</code></p>
<p>And add ejs as a dependency for the server:</p>
<p><code>$ npm install ejs --save</code></p>
<p>Next create the views folder and files:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ mkdir views</div><div class="line">$ mv public/index<span class="selector-class">.html</span> views/index<span class="selector-class">.ejs</span></div><div class="line">$ mkdir views/admin</div><div class="line">$ touch views/<span class="number">404</span><span class="selector-class">.ejs</span> views/admin/login<span class="selector-class">.ejs</span> views/admin/register<span class="selector-class">.ejs</span> views/admin/dashboard.ejs</div></pre></td></tr></table></figure></p>
<p>In the <strong>views/admin/login.ejs</strong> we will render a basic login form. This will load a full html page with a new <code>&lt;head&gt;</code> and <code>&lt;body&gt;</code>. The body of the template looks like this:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;body&gt;</div><div class="line">  &lt;<span class="selector-tag">div</span> class=<span class="string">'container'</span>&gt;</div><div class="line">    &lt;<span class="selector-tag">div</span> class=<span class="string">'row'</span>&gt;</div><div class="line">		&lt;<span class="selector-tag">div</span> class=<span class="string">'col-sm-4 col-sm-offset-4 text-center'</span>&gt;</div><div class="line">			&lt;h1&gt;Admin Login&lt;/h1&gt;</div><div class="line">			&lt;<span class="selector-tag">form</span> method=<span class="string">'post'</span> action=<span class="string">'/login'</span>&gt;</div><div class="line">				&lt;<span class="selector-tag">input</span> type=<span class="string">'text'</span> placeholder=<span class="string">'Email'</span> name=<span class="string">'email'</span> ng-model=<span class="string">'user.email'</span> class=<span class="string">'form-control'</span>&gt;</div><div class="line"></div><div class="line">				&lt;<span class="selector-tag">input</span> type=<span class="string">'password'</span> placeholder=<span class="string">'Password'</span> name=<span class="string">'password'</span> ng-model=<span class="string">'user.password'</span> class=<span class="string">'form-control'</span>&gt;</div><div class="line">				&lt;<span class="selector-tag">input</span> type=<span class="string">'submit'</span> class=<span class="string">'btn btn-primary'</span> value=<span class="string">'Login'</span>&gt;</div><div class="line">			&lt;/form&gt;</div><div class="line">			&lt;<span class="selector-tag">a</span> href=<span class="string">'/admin/register'</span>&gt;Register <span class="selector-tag">a</span> new account&lt;/a&gt;</div><div class="line">		&lt;/div&gt;</div><div class="line">	&lt;/div&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">&lt;/body&gt;</div></pre></td></tr></table></figure>
<p>Make sure to include bootstrap CSS and you’re golden. The register form looks like this:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;body&gt;</div><div class="line">  &lt;<span class="selector-tag">div</span> class=<span class="string">'container'</span>&gt;</div><div class="line">    &lt;<span class="selector-tag">div</span> class=<span class="string">'row'</span>&gt;</div><div class="line">      &lt;<span class="selector-tag">div</span> class=<span class="string">'col-sm-4 col-sm-offset-4 text-center'</span>&gt;</div><div class="line">        &lt;h1&gt;New user registration&lt;/h1&gt;</div><div class="line">        &lt;<span class="selector-tag">form</span> &lt;<span class="selector-tag">form</span> method=<span class="string">'post'</span> action=<span class="string">'/register'</span>&gt;</div><div class="line">          &lt;<span class="selector-tag">input</span> type=<span class="string">'text'</span> placeholder=<span class="string">'Email'</span> name=<span class="string">'email'</span> ng-model=<span class="string">'user.email'</span> class=<span class="string">'form-control'</span>&gt;</div><div class="line"></div><div class="line">          &lt;<span class="selector-tag">input</span> type=<span class="string">'password'</span> placeholder=<span class="string">'Password'</span> name=<span class="string">'password'</span> ng-model=<span class="string">'user.password'</span> class=<span class="string">'form-control'</span>&gt;</div><div class="line">          &lt;<span class="selector-tag">input</span> type=<span class="string">'submit'</span> class=<span class="string">'btn btn-primary'</span> value=<span class="string">'Register'</span>&gt;</div><div class="line">        &lt;/form&gt;</div><div class="line">        &lt;<span class="selector-tag">a</span> href=<span class="string">'/admin'</span>&gt;Login with an existing account&lt;/a&gt;</div><div class="line">      &lt;/div&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">&lt;/body&gt;</div></pre></td></tr></table></figure>
<p>Almost exactly the same. You can now check out the basic forms by navigating to <code>/admin</code> and <code>/admin/register</code>. The next step will be creating users and logging them in</p>
<h4 id="Create-user-model-and-set-up-passport"><a href="#Create-user-model-and-set-up-passport" class="headerlink" title="Create user model and set up passport"></a>Create user model and set up passport</h4><p>So in order to have admins we’re going to create a user model in our database. Create the model in <strong>server/models/user.js</strong>:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>),</div><div class="line">    passportLocalMongoose = <span class="built_in">require</span>(<span class="string">'passport-local-mongoose'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> User = <span class="keyword">new</span> mongoose.Schema(&#123;</div><div class="line">	email: &#123;</div><div class="line">		<span class="keyword">type</span>: <span class="built_in">String</span>, </div><div class="line">		required: <span class="string">'&#123;PATH&#125; is required!'</span></div><div class="line">	&#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// Passport-Local-Mongoose will add a username, </span></div><div class="line"><span class="comment">// hash and salt field to store the username, </span></div><div class="line"><span class="comment">// the hashed password and the salt value</span></div><div class="line"></div><div class="line"><span class="comment">// configure to use email for username field</span></div><div class="line">User.plugin(passportLocalMongoose, &#123; usernameField: <span class="string">'email'</span> &#125;);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = mongoose.model(<span class="string">'User'</span>, User);</div></pre></td></tr></table></figure>
<p>To make user management with passport.js simple we’re using <a href="https://github.com/saintedlama/passport-local-mongoose" target="_blank" rel="external">passport-local-mongoose</a>, which is a layer of abstraction on top of <a href="https://github.com/jaredhanson/passport-local" target="_blank" rel="external">passport-local</a>. Passport local is an “authentication strategy” on top of passport. You can include multiple strategies for different providers. This confused me for a long time. Scotch.io has a great <a href="https://scotch.io/tutorials/easy-node-authentication-setup-and-local" target="_blank" rel="external">tutorial series</a> on authenticating with multiple strategies in an express app. I also have an <a href="https://github.com/jasonshark/express-auth" target="_blank" rel="external">example app</a> that implements login with email/password, facebook and spotify together as one. For now we’re going to keep moving forward.</p>
<p><img src="http://media.giphy.com/media/1sSWWMNnaZLlm/giphy.gif" alt="keep swimming"></p>
<p>Install the dependencies:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm <span class="keyword">install</span> passport passport-<span class="keyword">local</span> passport-<span class="keyword">local</span>-mongoose <span class="comment">--save</span></div></pre></td></tr></table></figure></p>
<p>Initialize passport.js sessions in <strong>server.js</strong>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> passport = <span class="keyword">require</span>(<span class="string">'passport'</span>);</div><div class="line"><span class="keyword">require</span>(<span class="string">'./server/passport'</span>)(passport);   <span class="comment">// this file is defined below</span></div><div class="line">app.<span class="keyword">use</span>(passport.initialize());</div><div class="line">app.<span class="keyword">use</span>(passport.session());</div></pre></td></tr></table></figure>
<p>Define the passport configuration options in <strong>server/passport.js</strong>. I got this directly form the passport-local-mongoose <a href="https://github.com/saintedlama/passport-local-mongoose" target="_blank" rel="external">README</a>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// requires the model with Passport-Local Mongoose plugged in</span></div><div class="line"><span class="keyword">var</span> User = <span class="built_in">require</span>(<span class="string">'./models/user'</span>),</div><div class="line">	LocalStrategy = <span class="built_in">require</span>(<span class="string">'passport-local'</span>).Strategy;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">passport</span>)</span>&#123;</div><div class="line">	<span class="comment">// use static authenticate method of model in LocalStrategy</span></div><div class="line">	passport.use(User.createStrategy());</div><div class="line"></div><div class="line">	<span class="comment">// use static serialize and deserialize of model for passport session support</span></div><div class="line">	passport.serializeUser(User.serializeUser());</div><div class="line">	passport.deserializeUser(User.deserializeUser());</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h6 id="Create-routes-for-handling-user-login-registration"><a href="#Create-routes-for-handling-user-login-registration" class="headerlink" title="Create routes for handling user login/registration"></a>Create routes for handling user login/registration</h6><p>We have our forms that send plain old POST request. Set up some express routes with passport.js magical middleware. Middleware in express are functions that the request passes through when a route is hit. The request hits the route (for example POST to “/login”) and then goes through a series of functions that take the format <code>function(req, res, next){}</code>. If the <code>next()</code> function gets called the request continues down the chain. Passport provides us middleware that follows this <code>req, res, next</code> pattern:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/admin/dashboard'</span>, isAdmin, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</div><div class="line">		res.render(<span class="string">'admin/dashboard'</span>, &#123;<span class="attr">user</span>: req.user&#125;);</div><div class="line">	&#125;);</div><div class="line"></div><div class="line">	router.post(<span class="string">'/register'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</div><div class="line"></div><div class="line">		<span class="comment">// passport-local-mongoose: Convenience method to register a new user instance with a given password. Checks if username is unique</span></div><div class="line">		User.register(<span class="keyword">new</span> User(&#123;</div><div class="line">			<span class="attr">email</span>: req.body.email</div><div class="line">		&#125;), req.body.password, <span class="function"><span class="keyword">function</span>(<span class="params">err, user</span>) </span>&#123;</div><div class="line">	        <span class="keyword">if</span> (err) &#123;</div><div class="line">	            <span class="built_in">console</span>.error(err);</div><div class="line">	            <span class="keyword">return</span>;</div><div class="line">	        &#125;</div><div class="line"></div><div class="line">	        <span class="comment">// log the user in after it is created</span></div><div class="line">	        passport.authenticate(<span class="string">'local'</span>)(req, res, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	        	<span class="built_in">console</span>.log(<span class="string">'authenticated by passport'</span>);</div><div class="line">	        	res.redirect(<span class="string">'/admin/dashboard'</span>);</div><div class="line">	        &#125;);</div><div class="line">	    &#125;);</div><div class="line">	&#125;);</div><div class="line"></div><div class="line">	router.post(<span class="string">'/login'</span>, passport.authenticate(<span class="string">'local'</span>), <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</div><div class="line">		res.redirect(<span class="string">'/admin/dashboard'</span>);</div><div class="line">	&#125;);</div><div class="line"></div><div class="line">	app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</div><div class="line">		res.status(<span class="number">404</span>);</div><div class="line"></div><div class="line">		res.render(<span class="string">'404'</span>);</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;);</div></pre></td></tr></table></figure>
<p>Make sure you have the mongoose User model defined:</p>
<p><code>var User = require(&#39;./models/user&#39;)</code></p>
<p>You’ll see that I threw in an <code>isAdmin</code> variable. That is some middleware I defined myself. It is janky but it will make sure that even if someone registers an account they cannot get to the dashboard unless they log in with my email address.</p>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isAdmin</span>(</span>req, res, <span class="keyword">next</span>)&#123;</div><div class="line">	<span class="keyword">if</span>(req.isAuthenticated() &amp;&amp; req.user.email === <span class="comment">'connorleech@gmail.com')&#123;</span></div><div class="line">		console.<span class="built_in">log</span>(<span class="comment">'cool you are an admin, carry on your way');</span></div><div class="line">		<span class="keyword">next</span>();</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		console.<span class="built_in">log</span>(<span class="comment">'You are not an admin');</span></div><div class="line">		res.redirect(<span class="comment">'/admin');</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>For more complex apps you could add roles to users. You could add roles by issuing commands to records in MongoDB directly. Here’s how to check out the contents of our database (go ahead and <code>/admin/register</code> first, so you have some data to look at!)</p>
<h4 id="Check-in-the-database-that-users-exist"><a href="#Check-in-the-database-that-users-exist" class="headerlink" title="Check in the database that users exist"></a>Check in the database that users exist</h4><p>Let’s check out our database. Open up a mongo shell (<code>$ mongod</code> must be running).</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ mongo</div><div class="line">&gt; show dbs</div><div class="line">ghost-clone     0.078GB</div><div class="line">test            0.078GB</div><div class="line">&gt; use ghost-clone</div><div class="line">switched <span class="keyword">to</span> db ghost-clone</div><div class="line">&gt; show collections</div><div class="line">system.indexes<span class="built_in"></span></div><div class="line">users</div><div class="line">&gt; db.users.<span class="builtin-name">find</span>();</div></pre></td></tr></table></figure>
<p>This changes into our database and shows the users. The database may be called “mean-starter” if you do not rename the development database in <strong>server/env.js</strong>.</p>
<h4 id="Set-up-the-admin-dashboard"><a href="#Set-up-the-admin-dashboard" class="headerlink" title="Set up the admin dashboard"></a>Set up the admin dashboard</h4><p>We’ve created users in the database and logged them in. What we actually want is a protected dashboard where we can create, edit and save our posts.</p>
<p>First we’re going to set up the layout and create a new angular app called <code>ghost-clone.admin</code>. This app will handle everything that goes on from the <strong>dashboard.ejs</strong> template. I’ve set it up a little like how the ghost platform works. We can add more functionality in later tutorials.</p>
<p><img src="http://cdn.meme.am/instances2/500x/700982.jpg" alt=""></p>
<p>I changed the <code>public/</code> directory to distinguish between our admin angular app and the home angular app:</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public</div><div class="line">  |<span class="type">- admin</span></div><div class="line">     |<span class="type">- js</span></div><div class="line">     |<span class="type">- css</span></div><div class="line">     |<span class="type">- templates</span></div><div class="line">  |<span class="type">- home</span></div><div class="line">     |<span class="type">- js</span></div><div class="line">     |<span class="type">- css</span></div><div class="line">     |<span class="type">- templates</span></div><div class="line">``` </div><div class="line"></div><div class="line">Create the angular app <span class="built_in">in</span> **public/admin/js/app.js**:</div></pre></td></tr></table></figure>
<p>var adminApp = angular.module(‘ghost-clone.admin’, [<br>    ‘ui.router’,<br>    ‘btford.markdown’<br>]);</p>
<p>adminApp.config(function($stateProvider, $urlRouterProvider){</p>
<pre><code>$urlRouterProvider.otherwise(&apos;/&apos;);

$stateProvider
    .state(&apos;allPosts&apos;, {
        url: &apos;/&apos;,
        templateUrl: &apos;/admin/templates/allPosts.html&apos;
    })
    .state(&apos;addPost&apos;, {
        url: &apos;/addPost&apos;,
        templateUrl: &apos;/admin/templates/addPost.html&apos;
    })
</code></pre><p>});<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Next we're going <span class="keyword">to</span> hand off <span class="keyword">the</span> user object passport added <span class="keyword">on</span> <span class="keyword">the</span> server `req.user` <span class="keyword">to</span> our `user` variable <span class="keyword">and</span> give <span class="keyword">that</span> <span class="keyword">to</span> <span class="keyword">the</span> angular <span class="built_in">application</span>.</div></pre></td></tr></table></figure></p>
<p><script src="/admin/js/app.js"></script><br>  <script type="text/javascript"><br>    var currentUser = <%- JSON.stringify(user); %>;<br>    adminApp.run(function($rootScope){<br>      $rootScope.currentUser = currentUser;<br>    });<br>  </script><br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">The &#123;% raw %&#125;<span class="code">`&lt;%- -%&gt;`</span>&#123;% endraw %&#125; is how ejs renders variables. We stringify that and then pass it to our $rootScope.</div><div class="line"></div><div class="line">![<span class="string">ejs variables to angular.js</span>](<span class="link">http://cdn.meme.am/instances2/500x/700964.jpg</span>)</div><div class="line"></div><div class="line">In the body I link to a navbar template:</div><div class="line"></div><div class="line"><span class="code">`&lt;div ng-include='"/admin/templates/nav.html"'&gt;&lt;/div&gt;`</span>.</div><div class="line"></div><div class="line">It's important to note now angular's using client side templates with ui.router. These are separate from the server-side ejs templates.</div><div class="line"></div><div class="line">So now create a navbar template in <span class="strong">**public/admin/templates/nav.html**</span>:</div></pre></td></tr></table></figure></p>
<!-- Top navigation -->
<p><nav class="navbar navbar-default navbar-fixed-top" ng-controller="NavCtrl"><br>    <div class="container"><br>      <div class="navbar-header"><br>        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><br>          <span class="sr-only">Toggle navigation</span><br>          <span class="icon-bar"></span><br>          <span class="icon-bar"></span><br>          <span class="icon-bar"></span><br>        </button><br>        <a class="navbar-brand" href="#">Ghost clone</a><br>      </div><br>      <div id="navbar" class="navbar-collapse collapse"><br>        <ul class="nav navbar-nav"><br>          <li ng-class="{ active: isActive('allPosts') }"><a ui-sref="allPosts">All posts</a></li><br>          <li ng-class="{ active: isActive('addPost') }"><a ui-sref="addPost">New Post</a></li><br>        </ul><br>        <ul class="nav navbar-nav navbar-right"><br>          <li><a href="">{{currentUser.email}}</a></li><br>        </ul><br>      </div><!--/.nav-collapse --><br>    </div><br>  </nav><br><!-- /Top navigation --><br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">And also make a `NavCtrl` <span class="keyword">for</span> this navbar <span class="keyword">that</span> will toggle <span class="keyword">the</span> `.active` <span class="built_in">class</span> based <span class="keyword">on</span> <span class="keyword">the</span> current $state ui.router <span class="keyword">is</span> <span class="keyword">in</span>:</div></pre></td></tr></table></figure></p>
<p>adminApp.controller(‘NavCtrl’, function($scope, $state){<br>    $scope.active = $state;<br>    $scope.isActive = function(viewLocation){<br>        var active = (viewLocation === $state.current.name);<br>        return active;<br>    };<br>})</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Below <span class="keyword">the</span> nav.html tag <span class="keyword">in</span> **dashboard.ejs** <span class="built_in">include</span> <span class="keyword">a</span> <span class="literal">space</span> <span class="built_in">to</span> render our views</div><div class="line"></div><div class="line">`&lt;<span class="keyword">div</span> ui-view class=<span class="string">'full-height'</span> id=<span class="string">'main-content'</span>&gt;&lt;/<span class="keyword">div</span>&gt;`</div><div class="line"></div><div class="line">Add <span class="keyword">then</span> paste some CSS <span class="keyword">into</span> **public/admin/css/main.css**:</div></pre></td></tr></table></figure>
<p>html, body, section, .full-height {<br>    height: 100%;<br>}</p>
<p>#pad{<br>    font-family: Menlo,Monaco,Consolas,”Courier New”,monospace;</p>
<pre><code>border: none;
overflow: auto;
outline: none;
resize: none;

-webkit-box-shadow: none;
-moz-box-shadow: none;
box-shadow: none;
</code></pre><p>}</p>
<p>#markdown {<br>    overflow: auto;<br>    border-left: 1px solid black;<br>}</p>
<p>#main-content {<br>    margin-top:70px;<br>}<br><figure class="highlight http"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="markdown"><span class="section">#### Parsing markdown</span></span></div><div class="line"></div><div class="line">We're going to create two more templates to add a post and also show all of our posts. Create two files <span class="strong">**addPost.html**</span> and <span class="strong">**allPosts.html**</span> in <span class="strong">**public/admin/templates**</span>.</div><div class="line"></div><div class="line">Next add the [<span class="string">angular-markdown-directive</span>](<span class="link">https://github.com/jasonshark/angular-markdown-directive</span>). Grab the <span class="strong">**markdown.js**</span> file and include it as a <span class="code">`&lt;script&gt;`</span> in <span class="strong">**dashboard.ejs**</span>.</div><div class="line"></div><div class="line">Also add <span class="code">`ngSanitize`</span> and the [<span class="string">showdown.js</span>](<span class="link">https://github.com/showdownjs/showdown</span>) library:</div></pre></td></tr></table></figure></p>
<p><script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.2/angular-sanitize.js"></script><br>   <script src="https://cdn.rawgit.com/showdownjs/showdown/1.0.2/dist/showdown.min.js"></script></p>
<p><script src="/admin/js/lib/markdown.js"></script><br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Then create <span class="selector-tag">a</span> template <span class="keyword">for</span> adding <span class="selector-tag">a</span> title and <span class="selector-tag">a</span> <span class="selector-tag">body</span>. On the <span class="attribute">right</span> hand column we<span class="string">'ll view the markdown preview of the post we'</span>re posting:</div></pre></td></tr></table></figure></p>
<p><div class="row full-height"><br>    <div class="col-lg-12"><br>      <div class="form-group"><br>      <input type="text" placeholder="Title" name="title" class="form-control"><br>      </div><br>    </div><br>    <div class="col-lg-12 full-height"><br>        <textarea class="col-md-6 full-height" id="pad" ng-model="text" placeholder="Write your blog post here..."></textarea><br>        <div class="col-md-6 full-height" id="markdown"><br>          <div btf-markdown="text"></div><br>        </div><br>    </div><br></div><br>```</p>
<p>Navigate to New Post (<a href="http://localhost:3000/admin/dashboard#/addPost" target="_blank" rel="external">http://localhost:3000/admin/dashboard#/addPost</a>), start typing a <code># title</code> and you’ll see the markdown preview version, thanks to showdown.js and angular.js data binding.</p>
<h4 id="Conclusion-for-now"><a href="#Conclusion-for-now" class="headerlink" title="Conclusion (for now)"></a>Conclusion <small>(for now)</small></h4><p>We have a database of users, protected admin access, two angular applications and a template for parsing markdown.</p>
<p>In the next post we will Create, Read, Update and Delete posts. If you have questions about this tutorial, feel free to <a href="http://twitter.com/cleechtech" target="_blank" rel="external">hit me up on twitter</a>.</p>
<p><img src="http://media0.giphy.com/media/V0BIjUQRfl8tO/giphy.gif" alt=""></p>
<p>Also check out the <a href="https://github.com/jasonshark/mean-blog" target="_blank" rel="external">SOURCE CODE</a>.</p>

	</div>
</div>
	
</body>
</html>