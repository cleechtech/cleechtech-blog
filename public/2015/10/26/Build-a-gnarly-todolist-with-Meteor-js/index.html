<!DOCTYPE html>
<html>
<head>
	<!-- Google Tag Manager -->
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-KNQM2VC');</script>
	<!-- End Google Tag Manager -->

	<title>Connor Leech</title>

	<!-- Meta -->
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- Favicon -->
	<link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">

	<!-- Fonts -->
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
	<link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

	<!-- Bootstrap -->
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
	<link rel='stylesheet' href='css/readable.bootswatch.css'>
	<link rel='stylesheet' href='css/main.css'>

</head>
<body id='wrapper'>
	<div class='container blog-post'>
	<div class='row'>
		<div class='col-sm-12'>
			<a href='/' class="btn btn-yellow btn-circle" style='color:grey;'>
            	<i class="fa fa-home fa-2"></i>
        	</a>
		</div>
	</div>
	<div class='row'>
		<h1 class='author-name'>Build a gnarly todolist with Meteor.js</h1>
	    October 26, 2015 
	    <hr />
		<p>So I’ve gone through how to build a barebones, functional, fullstack application with meteor in <a href="http://connorleech.ghost.io/how-to-build-an-app-using-meteor-js/" target="_blank" rel="external">How to build an app using Meteor.js</a>. That said, it is not impressive. Last week I went through Eventedmind’s excellent course on how to <a href="https://www.eventedmind.com/classes/build-a-multi-page-app-with-iron-meteor-6737880d" target="_blank" rel="external">Build a multi page app with iron meteor</a>. It is a bit like how to build a barebones blog, complete with authentication.</p>
<a id="more"></a>
<p>The <a href="http://js-meteor-todos.meteor.com/" target="_blank" rel="external">DEMO</a> is here. I used meteor’s built in deployment. I had <a href="https://github.com/iron-meteor/iron-cli/issues/153" target="_blank" rel="external">some trouble</a> deploying the app to heroku. Suggestions welcome!</p>
<p>Rather than copying the eventedmind tutorial I’m going to point out some cool pieces of the <a href="https://github.com/jasonshark/meteor-todos" target="_blank" rel="external">CODE</a>.</p>
<h3 id="First-off"><a href="#First-off" class="headerlink" title="First off"></a>First off</h3><p><img src="http://media.giphy.com/media/4P1nnTxsFtsje/giphy.gif" alt="imma let you finish"></p>
<p>The app is structured using the Iron command line tool. Iron is like yeoman but for meteor apps. If that’s not helpful ignore it. To handle routing with meteor you will most likely use Iron Router. This is iron scaffolding. It’s an opinionated, structured way to build your meteor apps. To build an empty skeleton you go like:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> npm install -g iron-meteor</span></div><div class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> &lt;repo_url&gt;</span></div><div class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> meteor-todos</span></div><div class="line"><span class="meta">$</span><span class="bash"> iron</span></div></pre></td></tr></table></figure>
<p>Next we’ll add helpful packages and remove some crappy ones.</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ iron <span class="keyword">add</span><span class="bash"> less</span></div><div class="line">$ iron <span class="keyword">add</span><span class="bash"> bootstrap</span></div><div class="line">$ iron <span class="keyword">add</span><span class="bash"> accounts-ui</span></div><div class="line">$ iron <span class="keyword">add</span><span class="bash"> accounts-meteor-developer</span></div><div class="line">$ iron <span class="keyword">add</span><span class="bash"> momentjs:moment</span></div><div class="line">$ iron remove autopublish</div><div class="line">$ iron remove insecure</div></pre></td></tr></table></figure>
<p>The accounts-ui and accounts-meteor-developer abstract away all authentication headache. There are also accounts-facebook, accounts-google, accounts-twitter packages. The last two come by default and we want to turn them off. Insecure allows you to write to the database from the console (don’t want that) and autopublish makes all data accessible. The code from the tutorial uses best practices.</p>
<h3 id="Structure"><a href="#Structure" class="headerlink" title="Structure"></a>Structure</h3><p>All the app’s code is in the <a href="https://github.com/jasonshark/meteor-todos/tree/master/app" target="_blank" rel="external">app</a> folder. This is exactly the code that’d be generated by running <code>meteor create my_app_name</code>. If you want to run any <code>meteor</code> commands cd into the app folder and you’re good to go. (That’s exactly how I deployed [<code>$ cd app $ meteor deploy</code>]).</p>
<p>The main folders within app to worry about are <code>client</code>, <code>lib</code> and <code>server</code>. As specified in the <a href="http://docs.meteor.com/#/basic/filestructure" target="_blank" rel="external">documentation</a> client only runs on client, server only on server and lib runs on both.</p>
<h3 id="lib"><a href="#lib" class="headerlink" title="lib"></a>lib</h3><p>I’ll start with lib cause that’s where our routes are defined. They look like: </p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">Router</span><span class="selector-class">.configure</span>(&#123;</div><div class="line">  <span class="attribute">layoutTemplate</span>: <span class="string">'MasterLayout'</span>,</div><div class="line">  <span class="attribute">loadingTemplate</span>: <span class="string">'Loading'</span>,</div><div class="line">  <span class="attribute">notFoundTemplate</span>: <span class="string">'NotFound'</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="selector-tag">Router</span><span class="selector-class">.route</span>(<span class="string">'/'</span>, &#123;</div><div class="line">  <span class="attribute">name</span>: <span class="string">'home'</span>,</div><div class="line">  <span class="attribute">controller</span>: <span class="string">'HomeController'</span>,</div><div class="line">  <span class="attribute">action</span>: <span class="string">'action'</span>,</div><div class="line">  <span class="attribute">where</span>: <span class="string">'client'</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="selector-tag">Router</span><span class="selector-class">.route</span>(<span class="string">'/todos/:_id'</span>, &#123;</div><div class="line">	<span class="attribute">name</span>: <span class="string">'todos.detail'</span>,</div><div class="line">	<span class="attribute">controller</span>: <span class="string">'TodosController'</span>,</div><div class="line">	<span class="attribute">action</span>: <span class="string">'detail'</span>,</div><div class="line">	<span class="attribute">where</span>: <span class="string">'client'</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="selector-tag">Router</span><span class="selector-class">.route</span>(<span class="string">'/todos/:_id/edit'</span>, &#123;</div><div class="line">	<span class="attribute">name</span>: <span class="string">'todos.edit'</span>,</div><div class="line">	<span class="attribute">controller</span>: <span class="string">'TodosController'</span>,</div><div class="line">	<span class="attribute">action</span>: <span class="string">'edit'</span>,</div><div class="line">	<span class="attribute">where</span>: <span class="string">'client'</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="selector-tag">Router</span><span class="selector-class">.route</span>(<span class="string">'/users/:_id'</span>, &#123;</div><div class="line">  <span class="attribute">name</span>: <span class="string">'users.detail'</span>,</div><div class="line">  <span class="attribute">controller</span>: <span class="string">'UsersController'</span>,</div><div class="line">  <span class="attribute">action</span>: <span class="string">'detail'</span>,</div><div class="line">  <span class="attribute">where</span>: <span class="string">'client'</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>In my previous post on meteor we did not use controllers, now we do. The controller looks like this:</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">TodosController = RouteController.extend(&#123;</div><div class="line">  subscriptions: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.subscribe(<span class="string">'todoDetail'</span>, <span class="keyword">this</span>.params._id);</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="comment">// set data context for controller</span></div><div class="line">  data: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Todos.findOne(&#123;_id: <span class="keyword">this</span>.params._id&#125;);</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  detail: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">this</span>.render(<span class="string">'TodosDetail'</span>, &#123;&#125;);</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  edit: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="comment">// reactive state variable saying we're in edit mode</span></div><div class="line">    <span class="keyword">this</span>.state.set(<span class="string">'isEditing'</span>, <span class="literal">true</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">this</span>.render(<span class="string">'TodosDetail'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>And finally we have a collection in <code>app/collections/todos.js</code>:</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">Todos = <span class="keyword">new</span> Mongo.Collection(<span class="symbol">'todos</span>');</div><div class="line"></div><div class="line">// <span class="keyword">if</span> server define security rules</div><div class="line">// server code <span class="keyword">and</span> code inside methods are <span class="keyword">not</span> affected by allow <span class="keyword">and</span> deny</div><div class="line">// these rules only apply <span class="keyword">when</span> insert, update, <span class="keyword">and</span> remove are called from untrusted client code</div><div class="line"></div><div class="line"><span class="keyword">if</span> (Meteor.isServer) &#123;</div><div class="line">  // first argument <span class="keyword">is</span> id <span class="keyword">of</span> logged <span class="keyword">in</span> user. (null <span class="keyword">if</span> <span class="keyword">not</span> logged <span class="keyword">in</span>)</div><div class="line">  Todos.allow(&#123;</div><div class="line">    // can <span class="keyword">do</span> anythin <span class="keyword">if</span> you own the document</div><div class="line">    insert: <span class="keyword">function</span> <span class="title"></span>(userId, doc) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="type">userId</span> === doc.userId;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    update: <span class="keyword">function</span> <span class="title"></span>(userId, doc, fieldNames, modifier) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="type">userId</span> === doc.userId;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    remove: <span class="keyword">function</span> <span class="title"></span>(userId, doc) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="type">userId</span> === doc.userId;</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  // The deny method lets you selectively override your allow rules</div><div class="line">  // every deny callback must <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">for</span> the database change to happen</div><div class="line">  Todos.deny(&#123;</div><div class="line">    insert: <span class="keyword">function</span> <span class="title"></span>(userId, doc) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="type">false</span>;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    update: <span class="keyword">function</span> <span class="title"></span>(userId, doc, fieldNames, modifier) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="type">false</span>;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    remove: <span class="keyword">function</span> <span class="title"></span>(userId, doc) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="type">false</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>That’s kind of a lot of code, but for what it does it aint.</p>
<p><img src="https://40.media.tumblr.com/f0c2c2079b4978c2b99a46dc5f2edbc5/tumblr_mi3cxcm9w21rj4nx4o1_540.jpg" alt=""></p>
<p>The todo collection creates a MongoDB collection in the database that is accessible in the global <code>Todos</code> variable on the client and the server. The allow and deny callbacks handle our database permissions and security.</p>
<h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><p>The coolest thing on the server is the <a href="https://github.com/jasonshark/meteor-todos/blob/master/app/server/publish.js" target="_blank" rel="external">code</a> that publishes out our data:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Meteor.publish('items', function (param1, param2) &#123;</div><div class="line"> *  this.ready();</div><div class="line"> * &#125;);</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">var</span> allUsersCursor = Meteor.users.find(&#123;&#125;, &#123; fields: &#123; profile: <span class="number">1</span> &#125;&#125;);</div><div class="line"><span class="keyword">var</span> getCursorForUser = function(id)&#123;</div><div class="line">	<span class="keyword">return</span> Meteor.users.find(&#123;_id: id&#125;, &#123;fields: &#123; profile: <span class="number">1</span> &#125;&#125;)</div><div class="line">&#125;;</div><div class="line"></div><div class="line">Meteor.publish(<span class="string">'todos'</span>, function () &#123;</div><div class="line">	<span class="comment">// no data published if you're not logged in</span></div><div class="line">	<span class="keyword">if</span>(!<span class="keyword">this</span>.userId) <span class="keyword">return</span> <span class="keyword">this</span>.ready();</div><div class="line"></div><div class="line">	<span class="comment">// only allow people to see their own todos</span></div><div class="line">	<span class="comment">// this is currently logged in user</span></div><div class="line">	<span class="keyword">return</span> Todos.find(&#123;userId: <span class="keyword">this</span>.userId&#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">Meteor.publish(<span class="string">'todoDetail'</span>, function (id) &#123;</div><div class="line">	<span class="keyword">if</span>(!<span class="keyword">this</span>.userId) <span class="keyword">return</span> <span class="keyword">this</span>.ready();</div><div class="line"></div><div class="line">	<span class="keyword">var</span> todo = Todos.findOne(&#123; _id:id &#125;);</div><div class="line">	<span class="comment">// get cursors for user who owns todo and todo itself</span></div><div class="line">	<span class="comment">// fields specifies what to make available</span></div><div class="line">	<span class="keyword">return</span> [</div><div class="line">		getCursorForUser(todo.userId),</div><div class="line">		Todos.find(&#123;_id: id&#125;),</div><div class="line">		Comments.find(&#123;todoId: id&#125;, &#123; sort: &#123;createdAt: <span class="number">1</span>&#125;&#125;)</div><div class="line">	];</div><div class="line">&#125;);</div><div class="line"></div><div class="line">Meteor.publish(<span class="string">'users'</span>, function (<span class="comment">/* args */</span>) &#123;</div><div class="line">	<span class="keyword">if</span>(!<span class="keyword">this</span>.userId) <span class="keyword">return</span> <span class="keyword">this</span>.ready();</div><div class="line"></div><div class="line">	<span class="comment">// publish all users but specify which fields to make available</span></div><div class="line">	<span class="keyword">return</span> allUsersCursor;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">Meteor.publish(<span class="string">'user'</span>, function (userId) &#123;</div><div class="line">	<span class="keyword">if</span>(!<span class="keyword">this</span>.userId) <span class="keyword">return</span> <span class="keyword">this</span>.ready();</div><div class="line"></div><div class="line">	<span class="comment">// publish user data and their todos</span></div><div class="line">  <span class="keyword">return</span> [</div><div class="line">  	getCursorForUser(userId),</div><div class="line">  	Todos.find(&#123;userId: userId&#125;)</div><div class="line">  ];</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>In meteor you specify on the server what data to make accessible via publish functions. On the client you subscribe to that data. We handle our subscriptions in the controller. So scroll up and check out the Controller code. You’ll see:</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">subscriptions: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.subscribe(<span class="string">'todoDetail'</span>, <span class="keyword">this</span>.params._id);</div><div class="line"> &#125;,</div><div class="line"></div><div class="line"> <span class="comment">// set data context for controller</span></div><div class="line"> data: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> Todos.findOne(&#123;_id: <span class="keyword">this</span>.params._id&#125;);</div><div class="line"> &#125;,</div></pre></td></tr></table></figure>
<p>So we publish todoDetail on the server and then subscribe to it in the controller. This separates where data is accessible in your app. The data value is what specifically is available in your templates. Check out <a href="https://www.discovermeteor.com/blog/a-guide-to-meteor-templates-data-contexts/" target="_blank" rel="external">this guide to data contexts</a>. The difference between data contexts and subscriptions confused me for a bit. We’ll see how it works on the…</p>
<h3 id="client"><a href="#client" class="headerlink" title="client"></a>client</h3><p>We genereate templates using <code>$ iron g:template todos/todos_list</code> and commands like that. You can <a href="https://github.com/jasonshark/meteor-todos/tree/master/app/client/templates/todos" target="_blank" rel="external">see</a> the app is way broken up and every html file has a javascript file associated with it. This is where data context comes in. Each template has a name and associated <code>helpers</code> and <code>events</code> functions. Helpers essentially use the data context to show the data. Events are where you handle form submission, clicks, hovers etc using basically straight up jQuery. No directives or anything. Here’s the code for showing a todos detail and being able to edit it:</p>
<p><strong>app/client/templates/todos/todos_detail/todos_detail.js</strong><br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">Template.TodosDetail.events(&#123;</div><div class="line">	<span class="comment">// submit edit todo form</span></div><div class="line">	<span class="string">'submit form.edit-todo'</span>: <span class="function"><span class="keyword">function</span><span class="params">(e, tmpl)</span></span>&#123;</div><div class="line">		e.preventDefault();</div><div class="line"></div><div class="line">		<span class="keyword">var</span> subject = tmpl.find(<span class="string">'input[name=subject]'</span>).value;</div><div class="line">		<span class="keyword">var</span> description = tmpl.find(<span class="string">'[name=description]'</span>).value;</div><div class="line">		<span class="keyword">var</span> id = <span class="keyword">this</span>._id;</div><div class="line"></div><div class="line">		Todos.update(&#123;_id: id&#125;, &#123;</div><div class="line">			$<span class="keyword">set</span>: &#123;</div><div class="line">				subject: subject,</div><div class="line">				description: description,</div><div class="line">				updatedAt: <span class="keyword">new</span> Date</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line"></div><div class="line">		<span class="comment">// reroute and pass data context</span></div><div class="line">		Router.go(<span class="string">'todos.detail'</span>, &#123;_id: id&#125;)</div><div class="line">	&#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">Template.TodosDetail.helpers(&#123;</div><div class="line">	isMyTodo: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.userId === Meteor.userId();</div><div class="line">	&#125;,</div><div class="line">	todoOwner: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="comment">// data context is the todo</span></div><div class="line">		<span class="keyword">var</span> todo = <span class="keyword">this</span>;</div><div class="line">		<span class="keyword">return</span> Meteor.users.findOne(&#123;_id: todo.userId&#125;);</div><div class="line">	&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>So specify events for the template with jquery selectors as the values, like <code>submit form.edit-todo</code> then a function that gets the template and event as arguments. We write to the database using the global <code>Todos</code> collection. <code>update()</code> and <code>$set</code> are from MongoDB. Meteor uses mongodb so get familiar. The reason we can do this update is because we allow it when we define the todos collection. In the <a href="https://github.com/jasonshark/meteor-todos/blob/master/app/lib/controllers/todos_controller.js" target="_blank" rel="external">todos controller</a> (shown in the lib directory) we set the <code>data</code> value to be the specific todo whose id is a param from the url bar.</p>
<p>todos controller sets the data context:<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">data: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Todos.findOne(&#123;_id: <span class="keyword">this</span>.params._id&#125;);</div><div class="line">  &#125;,</div></pre></td></tr></table></figure></p>
<p>So in our template helper <code>this</code> is the data context that we specified in the controller. It is kind of crazy and easy to get confused. That’s why we give it a variable name. We be humans, not machines.</p>
<p>The code I’m talking about where we use the data context from the controller:<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">todoOwner: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="comment">// data context is the todo</span></div><div class="line">	<span class="keyword">var</span> todo = <span class="keyword">this</span>;</div><div class="line">	<span class="keyword">return</span> Meteor.users.findOne(&#123;_id: todo.userId&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Have a look through the code. I recommend the eventedmind screencast, that’s how I built this thang. If you have more questions hit me up on <a href="https://twitter.com/cleechtech" target="_blank" rel="external">twitter</a>.</p>
<p><img src="/content/images/2015/05/good_luck.gif" alt=""></p>
<h3 id="Other-helpful-bits"><a href="#Other-helpful-bits" class="headerlink" title="Other helpful bits"></a>Other helpful bits</h3><p><strong>Authentication</strong></p>
<p><code>{{> loginButons }}</code> in the template helps to get auth configured.</p>
<p>Programmatically <a href="http://docs.meteor.com/#/full/meteor_loginwithexternalservice" target="_blank" rel="external">configure</a> OAuth provider: <code>$ iron add service-configuration</code></p>
<p><strong>Startup</strong></p>
<p><code>server/bootstrap.js</code> is where any code goes that needs to run when we startup the server. Access environment variables from <code>config/development/env.sh</code> by using <code>process.env[&#39;variable_name&#39;]</code></p>
<p><strong>Database</strong></p>
<p>Activate a mongo shell for the current database with <code>$ iron mongo</code>. What user records look like in database:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$ meteor mongo</div><div class="line">MongoDB shell version: 2.6.7</div><div class="line">connecting <span class="keyword">to</span>: 127.0.0.1:3001/meteor</div><div class="line"></div><div class="line">meteor:PRIMARY&gt; show collections</div><div class="line">	meteor_accounts_loginServiceConfiguration</div><div class="line">	meteor_oauth_pendingCredentials</div><div class="line">	system.indexes</div><div class="line"><span class="built_in">	users</span></div><div class="line">meteor:PRIMARY&gt; db.meteor_accounts_loginServiceConfiguration.<span class="builtin-name">find</span>().pretty()</div><div class="line">	&#123;</div><div class="line">		<span class="string">"_id"</span> : <span class="string">"MJRdreKXQ8NCPnhH7"</span>,</div><div class="line">		<span class="string">"service"</span> : <span class="string">"meteor-developer"</span>,</div><div class="line">		<span class="string">"clientId"</span> : <span class="string">"Dyv7PX6SWqQXhLCxZ"</span>,</div><div class="line">		<span class="string">"secret"</span> : <span class="string">"hDePgZTKMMw6ksGKbGj3gC75TwXRpkhECh"</span>,</div><div class="line">		<span class="string">"loginStyle"</span> : <span class="string">"popup"</span></div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>The above is what meteor uses to register our users. The below is what user records look like.</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">meteor:PRIMARY&gt; db.users.find().pretty()</div><div class="line">	&#123;</div><div class="line">		<span class="string">"_id"</span> : <span class="string">"kj8iq7dpzbMGseDPy"</span>,</div><div class="line">		<span class="string">"createdAt"</span> : ISODate(<span class="string">"2015-05-21T21:59:46.840Z"</span>),</div><div class="line">		<span class="string">"services"</span> : &#123;</div><div class="line">			<span class="string">"meteor-developer"</span> : &#123;</div><div class="line">				<span class="string">"accessToken"</span> : <span class="string">"EzYgczXRvYRR6AyMG"</span>,</div><div class="line">				<span class="string">"expiresAt"</span> : NaN,</div><div class="line">				<span class="string">"username"</span> : <span class="string">"connorleech"</span>,</div><div class="line">				<span class="string">"emails"</span> : [</div><div class="line">					&#123;</div><div class="line">						<span class="string">"address"</span> : <span class="string">"connorleech@gmail.com"</span>,</div><div class="line">						<span class="string">"primary"</span> : true,</div><div class="line">						<span class="string">"verified"</span> : true</div><div class="line">					&#125;</div><div class="line">				],</div><div class="line">				<span class="string">"id"</span> : <span class="string">"zkS6ewa9nyYcPAgah"</span></div><div class="line">			&#125;,</div><div class="line">			<span class="string">"resume"</span> : &#123;</div><div class="line">				<span class="string">"loginTokens"</span> : [ ]</div><div class="line">			&#125;</div><div class="line">		&#125;,</div><div class="line">		<span class="string">"profile"</span> : &#123;</div><div class="line">			<span class="string">"name"</span> : <span class="string">"connorleech"</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>Access users in the browser console by typing: <code>Meteor.users.find().fetch()</code>. </p>
<p><code>.find()</code> returns a cursor. <code>.fetch()</code> turns the cursor into an array</p>
<p>security rules on <code>lib/collections/todos.js</code> prevent unauthorized writes to database.</p>
<p><strong>iron commands</strong></p>
<p>Add a publish function: <code>$ iron g:publish todos</code><br>Create collection in mongo database: <code>$ iron g:collection todos</code></p>
<p>Subscribe to publications within your controller.</p>
<h3 id="Heroku"><a href="#Heroku" class="headerlink" title="Heroku"></a>Heroku</h3><p>I tried to deploy with this:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> heroku login</span></div><div class="line"><span class="meta">$</span><span class="bash"> heroku git:remote -a &lt;name-of-heroku-app&gt;</span></div><div class="line"><span class="meta">$</span><span class="bash"> heroku config:<span class="built_in">set</span> BUILDPACK_URL=https://github.com/lirbank/meteor-buildpack-horse.git</span></div><div class="line"><span class="meta">$</span><span class="bash"> heroku config:<span class="built_in">set</span> ROOT_URL=https://&lt;yourapp&gt;.herokuapp.com</span></div><div class="line"><span class="meta">$</span><span class="bash"> git push heroku master</span></div><div class="line"><span class="meta">$</span><span class="bash"> heroku open</span></div></pre></td></tr></table></figure>
<p>I think something was wrong with my environment variables. The provided meteor deployment platform works for me for now.</p>
<p>Hope this is helpful! yeah I’m on <a href="https://twitter.com/cleechtech" target="_blank" rel="external">twitter</a></p>

	</div>
</div>
	
</body>
</html>