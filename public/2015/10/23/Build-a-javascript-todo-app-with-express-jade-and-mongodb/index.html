<!DOCTYPE html>
<html>
<head>
	<!-- Google Tag Manager -->
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-KNQM2VC');</script>
	<!-- End Google Tag Manager -->

	<title>Connor Leech</title>

	<!-- Meta -->
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- Favicon -->
	<link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">

	<!-- Fonts -->
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
	<link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

	<!-- Bootstrap -->
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
	<link rel='stylesheet' href='css/readable.bootswatch.css'>
	<link rel='stylesheet' href='css/main.css'>

</head>
<body id='wrapper'>
	<div class='container blog-post'>
	<div class='row'>
		<div class='col-sm-12'>
			<a href='/' class="btn btn-yellow btn-circle" style='color:grey;'>
            	<i class="fa fa-home fa-2"></i>
        	</a>
		</div>
	</div>
	<div class='row'>
		<h1 class='author-name'>Build a javascript todo app with express, jade and mongodb</h1>
	    October 23, 2015 
	    <hr />
		<p>Hey everyone today we’re going to build a super simple todo application using <a href="http://expressjs.com/4x/api.html" target="_blank" rel="external">express 4</a>. Express is a lightweight server side framework for node.js. It’s very popular but not quite as easy to get up and running with a database as something like Rails or Django.</p>
<p>In this tutorial we’ll connect an express server to a mongoDB database and serve our html using the jade templating engine. To make talking to MongoDB easier we will use the <a href="https://github.com/learnboost/mongoose" target="_blank" rel="external">mongoose</a> npm package. Even though mongodb is a schemaless database (everything is json) mongoose lets us define models and easily chain queries.</p>
<a id="more"></a>
<p><a href="https://github.com/jasonshark/express-todo" target="_blank" rel="external">SOURCE CODE</a> is on github here</p>
<p><a href="http://express-mongo-jade-todo.herokuapp.com" target="_blank" rel="external">LIVE DEMO</a> hosted by heroku is here</p>
<h3 id="Set-up-the-project"><a href="#Set-up-the-project" class="headerlink" title="Set up the project"></a>Set up the project</h3><p>Unlike Ruby On Rails, express allows you to set up your file structure any way you want. This was confusing to me when looking at other people’s code because I wasn’t sure what the best way to organize my project was. Here’s the directory structure I’m going to use today:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">express-todo</div><div class="line">  |-<span class="built_in"> config</span></div><div class="line">  |- public</div><div class="line">    |- javascripts</div><div class="line">    |- stylesheets</div><div class="line">    |- images</div><div class="line">  |- routes</div><div class="line">  |- views</div><div class="line">  .gitignore</div><div class="line">  package.json</div><div class="line">  server.js</div><div class="line">  README.md</div></pre></td></tr></table></figure>
<p><strong>public -</strong> this folder will hold files that everyone can see when they visit our page with a web browser. Here’s where we’ll put client side javascript and css.</p>
<p><strong>config -</strong> here we’re going to have everything to do with configuring our environments and managing our database</p>
<p><strong>routes -</strong> this is where we’ll have the server side application logic. If you’re coming from a rails background you might think of these as controllers</p>
<p><strong>views -</strong> our jade templates live here</p>
<p><strong>package.json -</strong> defines all packages (like express and mongoose) that our application depends on</p>
<p><strong>server.js -</strong> this is the main executable file for everything. To run our app we’ll run <code>node server</code> or <code>node server.js</code> from the command line (terminal on mac). If something doesn’t work, start here.</p>
<h3 id="Build-a-server"><a href="#Build-a-server" class="headerlink" title="Build a server"></a>Build a server</h3><p>Okay so now let’s get coding! We’re going to start but running up our <strong>server.js</strong> file to listen for hits to a specific port on our computers. With this file we’ll run a local web server on our computer. Later we’ll deploy this as a real web server for the interwebs.<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="keyword">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="keyword">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> favicon = <span class="keyword">require</span>(<span class="string">'serve-favicon'</span>);</div><div class="line"><span class="keyword">var</span> logger = <span class="keyword">require</span>(<span class="string">'morgan'</span>);</div><div class="line"><span class="keyword">var</span> cookieParser = <span class="keyword">require</span>(<span class="string">'cookie-parser'</span>);</div><div class="line"><span class="keyword">var</span> bodyParser = <span class="keyword">require</span>(<span class="string">'body-parser'</span>);</div><div class="line"><span class="keyword">var</span> port = <span class="number">3000</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"></div><div class="line"><span class="comment">// view engine setup</span></div><div class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</div><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'jade'</span>);</div><div class="line"></div><div class="line"><span class="comment">//app.use(favicon(__dirname + '/public/favicon.ico'));</span></div><div class="line">app.<span class="keyword">use</span>(logger(<span class="string">'dev'</span>));</div><div class="line">app.<span class="keyword">use</span>(bodyParser.json());</div><div class="line">app.<span class="keyword">use</span>(bodyParser.urlencoded());</div><div class="line">app.<span class="keyword">use</span>(cookieParser());</div><div class="line"><span class="comment">// telling Express to serve static objects from /public </span></div><div class="line">app.<span class="keyword">use</span>(express.<span class="keyword">static</span>(path.join(__dirname, <span class="string">'public'</span>)));</div><div class="line"></div><div class="line"><span class="comment">// Start server</span></div><div class="line">app.listen(port, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</div><div class="line">  console.log(<span class="string">'Server listening on port '</span> + port)</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>First we tell express where to find our templates (ie the views directory) and then tell express to use jade as our template engine. <a href="https://www.npmjs.com/package/body-parser" target="_blank" rel="external">body-parser</a> is for handling form inputs. Cookies we won’t use but I included anyways. The next line tells express where to serve static assets from so all our server code isn’t visible to everybody.</p>
<p>You can check this code works by running <code>node server</code> in the command line. You should get “Server is listening on port 3000”. Then check <code>localhost:3000</code> in your web browser and you’ll see an error</p>
<p>“Cannot GET /“</p>
<p>This is because we haven’t defined any routes.</p>
<h3 id="Define-our-routes"><a href="#Define-our-routes" class="headerlink" title="Define our routes"></a>Define our routes</h3><p>Routes are essentially urls for your website. So when you went to <code>localhost:3000</code> you visited the base root <code>/</code>. For our website we’ll want routes for viewing, creating and editing todos. So modify <strong>server.js</strong> after the express.static line and before app.listen.</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Routes</span></div><div class="line"><span class="built_in">var</span> main = <span class="keyword">require</span>(<span class="string">'./routes/main'</span>);</div><div class="line"><span class="built_in">var</span> todo = <span class="keyword">require</span>(<span class="string">'./routes/todo'</span>);</div><div class="line"><span class="built_in">var</span> todoRouter = express.Router();</div><div class="line">app.use(<span class="string">'/todos'</span>, todoRouter);</div><div class="line"></div><div class="line">app.get(<span class="string">'/'</span>, main.index);</div><div class="line">todoRouter.get(<span class="string">'/'</span>, todo.<span class="literal">all</span>);</div><div class="line">todoRouter.post(<span class="string">'/create'</span>, todo.create);</div><div class="line">todoRouter.post(<span class="string">'/destroy/:id'</span>, todo.destroy);</div><div class="line">todoRouter.post(<span class="string">'/edit/:id'</span>, todo.edit);</div></pre></td></tr></table></figure>
<p>Also create two files, <strong>main.js</strong> and <strong>todo.js</strong> in the routes folder. Before jumping in to those files let’s look at the new express routes we defined. The user can visit our homepage <code>/</code>, they’ll be able to see all todos at <code>/todos</code>, create todos by sending a post request to <code>/todos/create</code> and delete todos by sending a delete request to <code>/todos/destroy/:id</code>. <code>:id</code> is will be the unique database id provided to us by mongodb. Finally they’ll be able to update todos by sending a put request to <code>/todos/edit/:id</code> and view individual todos at <code>/todos/:id</code>.</p>
<p>Each of these scenarios will be handled with a function that takes two parameters – request and response.</p>
<p>Define the todo handler functions in <strong>routes/todo.js</strong> with some empty content for now:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">    <span class="attr">all</span>: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</div><div class="line">        res.send(<span class="string">'All todos'</span>)</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">viewOne</span>: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Viewing '</span> + req.params.id);</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">create</span>: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Todo created'</span>)</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">destroy</span>: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Todo deleted'</span>)</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">edit</span>: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Todo '</span> + req.params.id + <span class="string">' updated'</span>)</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>So in this file we have an object with keys and handler functions as values. <code>module.exports</code> makes the object in this file usable in our server.js file. <code>req.params.id</code> takes the value directly from the url bar. Try visiting <code>localhost:3000/todos/blahblahblah</code> in your web browser. The console.log messages will log out in your terminal and you will see “Viewing blahblahblah”.</p>
<h3 id="Getting-jaded"><a href="#Getting-jaded" class="headerlink" title="Getting jaded"></a>Getting jaded</h3><p>Let’s get the homepage setup. In our server.js <code>app.get(&#39;/&#39;, main.index);</code> this line handles our homepage. Define the controller function in routes/main.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">	<span class="attr">index</span>: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">		res.render(<span class="string">'main'</span>, &#123; <span class="attr">title</span>: <span class="string">'Express Todo'</span> &#125;);</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>res.render</code> renders a view. We already told express our views are in the <code>views</code> folder and that we’re using jade templating. Create a file <strong>main.jade</strong>:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">extends layout</div><div class="line"></div><div class="line">block <span class="attribute">content</span></div><div class="line">	h1= title</div><div class="line">	<span class="selector-tag">p</span> Welcome to #&#123;title&#125;</div><div class="line">    a(href=<span class="string">'/todos'</span>)<span class="selector-class">.btn</span><span class="selector-class">.btn-success</span><span class="selector-class">.btn-lg</span> View all todos</div></pre></td></tr></table></figure></p>
<p>And also create a <strong>layout.jade</strong> in the views folder:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">doctype html</div><div class="line">html</div><div class="line">	title Express Todo</div><div class="line">    link(<span class="attribute">rel</span>=<span class="string">"stylesheet"</span>, <span class="attribute">href</span>=<span class="string">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css"</span>)</div><div class="line">	link(<span class="attribute">rel</span>=<span class="string">"stylesheet"</span>, <span class="attribute">href</span>=<span class="string">"/stylesheets/main.css"</span>)</div><div class="line">body</div><div class="line">	block content</div></pre></td></tr></table></figure></p>
<p>Here we include twitter bootstrap cdn link for styling. Click the big green button and you’ll navigate to <code>/todos</code>. Be careful not to mix tabs and spaces in your jade code. You have to use one or the other or Mrs. Jade becomes angry</p>
<h3 id="Add-MongoDB"><a href="#Add-MongoDB" class="headerlink" title="Add MongoDB"></a>Add MongoDB</h3><p>Now that we have our server up and serving up content, let’s connect it to a local database. First add mongoose as a dependency. So from the terminal:</p>
<p><code>$ npm install mongoose --save</code></p>
<p>Also check that you have mongodb installed with <code>$ mongo --version</code>. Open a brand new terminal and run </p>
<p><code>$ mongod</code></p>
<p>This wakes MongoDB up and allows it to operate. In order to connect to a local mongodb database, mongod must be running.</p>
<p>In another terminal window enter <code>$ mongo</code> we’re going to create a local mongodb database:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ mongo</div><div class="line">MongoDB shell version: 2.6.4</div><div class="line">connecting <span class="keyword">to</span>: test<span class="built_in"></span></div><div class="line">Server has startup warnings: </div><div class="line">2014-12-24T10:30:36.556-0800 [initandlisten] </div><div class="line">2014-12-24T10:30:36.556-0800 [initandlisten] ** WARNING: soft rlimits too low. Number of files is 256, should be at least 1000</div></pre></td></tr></table></figure>
<p>In this REPL type <code>use express-todo</code> to create our local database. To see all the databases you have type <code>show dbs</code>. To quit the mongo terminal press Ctrl + C</p>
<h4 id="Define-data-model-and-connect"><a href="#Define-data-model-and-connect" class="headerlink" title="Define data model and connect"></a>Define data model and connect</h4><p>Even though mongodb is schemaless, to model our data with mongoose we still need to define models. Create a new folder inside config called <strong>models</strong> and add a new file called <strong>Todo.js</strong>. We’ll then define what our todo data will look like with a schema:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>),</div><div class="line">	Schema = mongoose.Schema;</div><div class="line"></div><div class="line"><span class="comment">// todo model</span></div><div class="line"><span class="keyword">var</span> todoSchema = <span class="keyword">new</span> Schema(&#123;</div><div class="line">    content: <span class="built_in">String</span>,</div><div class="line">    completed: &#123; <span class="keyword">type</span>: <span class="built_in">Boolean</span>, <span class="keyword">default</span>: <span class="literal">false</span> &#125;,</div><div class="line">    updated_at: &#123; <span class="keyword">type</span>: <span class="built_in">Date</span>, <span class="keyword">default</span>: <span class="built_in">Date</span>.now &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">mongoose.model(<span class="string">'Todo'</span>, todoSchema);</div></pre></td></tr></table></figure>
<p>Next in <strong>server.js</strong> add this code above the code for the routes:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">require</span>(<span class="string">'./config/models/Todo'</span>);</div><div class="line">mongoose.connect(<span class="string">'mongodb://localhost/express-todo'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'connected to database!'</span>)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>This registers our todo schema and connects to the local mongodb database.</p>
<h3 id="Show-Todos"><a href="#Show-Todos" class="headerlink" title="Show Todos"></a>Show Todos</h3><p>Even though our database is empty let’s query it. Update the code in <code>routes/todo.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>),</div><div class="line">    Todo = mongoose.model(<span class="string">'Todo'</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">    <span class="attr">all</span>: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</div><div class="line">        Todo.find(&#123;&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, todos</span>)</span>&#123;</div><div class="line">            <span class="keyword">if</span>(err) res.send(err);</div><div class="line">            res.json(todos);</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">...</div></pre></td></tr></table></figure>
<p>Here we include the Todo model we registered earlier, query it for all entries (the first parameter is optional here) and then respond with JSON to the web page.</p>
<p>If you visit <code>localhost:3000/todos</code> you should see an empty array on the page</p>
<h3 id="Creating-todos"><a href="#Creating-todos" class="headerlink" title="Creating todos"></a>Creating todos</h3><p>Create a view file called <strong>todos.jade</strong> that we’ll display all the todos on.</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">extends layout</div><div class="line"></div><div class="line">block <span class="attribute">content</span></div><div class="line">	<span class="selector-tag">h1</span><span class="selector-class">.text-center</span> All Todos</div><div class="line">	<span class="selector-tag">ul</span></div><div class="line">		<span class="keyword">for</span> todo <span class="keyword">in</span> todos</div><div class="line">			<span class="selector-tag">li</span> #&#123;todo.<span class="attribute">content</span>&#125;</div><div class="line">	form(method=<span class="string">'post'</span>, action=<span class="string">'/todos/create'</span>)</div><div class="line">		<span class="selector-class">.input-group</span></div><div class="line">			<span class="selector-tag">input</span>.form-control(type=<span class="string">'text'</span>, placeholder=<span class="string">'What do you have to do?'</span>, name=<span class="string">'content'</span>)</div><div class="line">			<span class="selector-tag">span</span><span class="selector-class">.input-group-btn</span></div><div class="line">				<span class="selector-tag">input</span><span class="selector-class">.btn</span><span class="selector-class">.btn-success</span>(type=<span class="string">'submit'</span>, value=<span class="string">'Add Todo'</span>)</div></pre></td></tr></table></figure>
<p>Here we have an unordered list to display the todos and a form that hits our server with a post request to add one.</p>
<p>Let’s define that route that the form hits. Open <code>routes/todo.js</code>. Here is the code for creating a todo and then reloading the page.</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="built_in">create</span>: <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span></span>&#123;</div><div class="line">    var todoContent = req.body.content;</div><div class="line">    // <span class="built_in">create</span> todo</div><div class="line">    Todo.<span class="built_in">create</span>(&#123; content: todoContent &#125;, <span class="function"><span class="keyword">function</span><span class="params">(err, todo)</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(err) res.render(<span class="string">'error'</span>, &#123; <span class="built_in">error</span>: <span class="string">'Error creating your todo :('</span>&#125;)</div><div class="line">        // reload collection</div><div class="line">        res.redirect(<span class="string">'/todos'</span>);</div><div class="line">    &#125;);</div><div class="line">&#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<p>Congrats! You now have a javascript server that can talk to a database and render the information in a web browser</p>
<h3 id="Deleting-todos"><a href="#Deleting-todos" class="headerlink" title="Deleting todos"></a>Deleting todos</h3><p>First update <strong>todos.jade</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">block <span class="attribute">content</span></div><div class="line">	<span class="selector-tag">h1</span><span class="selector-class">.text-center</span> All Todos</div><div class="line">	<span class="selector-class">.panel</span><span class="selector-class">.panel-default</span></div><div class="line">		<span class="keyword">for</span> todo <span class="keyword">in</span> todos</div><div class="line">			<span class="selector-class">.panel-body</span></div><div class="line">				a(href=<span class="string">'/todos/#&#123;todo._id&#125;'</span>) #&#123;todo.<span class="attribute">content</span>&#125;</div><div class="line">				form(action=<span class="string">'/todos/destroy/#&#123;todo._id&#125;'</span>, method=<span class="string">'post'</span>)</div><div class="line">					<span class="selector-tag">input</span><span class="selector-class">.btn</span><span class="selector-class">.btn-danger</span><span class="selector-class">.pull-right</span>(type=<span class="string">'submit'</span>, value=<span class="string">'Delete'</span>)</div></pre></td></tr></table></figure>
<p>For this we submit a form when pressing the button. The styling is not perfect but you can mess with that however you like.</p>
<p>Here’s the code to delete a todo and reload the page:</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">destroy: <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span></span>&#123;</div><div class="line">    <span class="keyword">var</span> id = req.params.id;</div><div class="line"></div><div class="line">    Todo.findByIdAndRemove(id, <span class="function"><span class="keyword">function</span><span class="params">(err, todo)</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(err) res.render(<span class="string">'error'</span>, &#123; error: <span class="string">'Error deleting todo'</span>&#125;);</div><div class="line">        res.redirect(<span class="string">'/todos'</span>);</div><div class="line">    &#125;);</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<h3 id="View-and-update-todos"><a href="#View-and-update-todos" class="headerlink" title="View and update todos"></a>View and update todos</h3><p>I’d like for each todo to have its own page and be able to edit the todo on that page. Create a <strong>todo.jade</strong> file in the views directory:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">extends layout</div><div class="line"></div><div class="line">block content</div><div class="line">	form(<span class="attribute">method</span>=<span class="string">'post'</span>, <span class="attribute">action</span>=<span class="string">'/todos/edit/#&#123;todo._id&#125;'</span>)</div><div class="line">		h1</div><div class="line">			input(<span class="attribute">value</span>=<span class="string">'#&#123;todo.content&#125;'</span>, <span class="attribute">name</span>=<span class="string">'content'</span>)</div><div class="line">			input(<span class="attribute">type</span>=<span class="string">'submit'</span>, <span class="attribute">value</span>=<span class="string">'Update'</span>).btn.btn-primary.btn-lg</div><div class="line">			a(<span class="attribute">href</span>=<span class="string">'/todos'</span>).btn.btn-default.btn-lg Back</div></pre></td></tr></table></figure>
<p>This extends the layout again and has a form for updating and also a back button. Here are the methods for viewing the page and handling the update request. (We redirect them back to the full list after update is complete.)</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">viewOne: <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span></span>&#123;</div><div class="line">    Todo.<span class="built_in">find</span>(&#123; _id: req.params.id &#125;, <span class="function"><span class="keyword">function</span><span class="params">(err, todo)</span></span>&#123;</div><div class="line">        res.render(<span class="string">'todo'</span>, &#123; todo: todo[<span class="number">0</span>] &#125;)</div><div class="line">    &#125;);</div><div class="line">&#125;,</div><div class="line">edit: <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span></span>&#123;</div><div class="line">        Todo.findOneAndUpdate(&#123; _id: req.params.id &#125;, &#123;content: req.body.content&#125;, <span class="function"><span class="keyword">function</span><span class="params">(err, todo)</span></span>&#123;</div><div class="line">            res.redirect(<span class="string">'/todos'</span>);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>Now we have a page for showing all todos and also each todo has its own page with its own unique url. Also we can add, delete and update all of our todos.</p>
<h3 id="Refactor"><a href="#Refactor" class="headerlink" title="Refactor"></a>Refactor</h3><p>Our code thus far won’t work in production because we’re reading from a local database. Also the server.js file has a lot of stuff thrown in there and does not need to be that heavy. Let’s clean it up.</p>
<p>New <strong>server.js</strong> file:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"></div><div class="line"><span class="comment">// Environments</span></div><div class="line"><span class="keyword">var</span> env = process.env.NODE_ENV || <span class="string">'development'</span>;</div><div class="line"><span class="keyword">var</span> envConfig = <span class="built_in">require</span>(<span class="string">'./config/env'</span>)[env];</div><div class="line"></div><div class="line"><span class="comment">// Express configuration</span></div><div class="line"><span class="built_in">require</span>(<span class="string">'./config/config'</span>)(app, envConfig);</div><div class="line"></div><div class="line"><span class="comment">// Database</span></div><div class="line"><span class="built_in">require</span>(<span class="string">'./config/database'</span>)(envConfig)</div><div class="line"></div><div class="line"><span class="comment">// Routes</span></div><div class="line"><span class="built_in">require</span>(<span class="string">'./config/routes'</span>)(app);</div><div class="line"></div><div class="line"><span class="comment">// Start server</span></div><div class="line">app.listen(envConfig.port, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Server listening on port '</span> + envConfig.port);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>So the first thing I did was create an <code>env.js</code> file in the config folder. That exports an object with a key for each environment (in our case production and development).</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> rootPath = path.normalize(__dirname + <span class="string">'/../'</span>); <span class="comment">// normalizes to base path</span></div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">	<span class="attr">development</span>: &#123;</div><div class="line">		<span class="attr">rootPath</span>: rootPath,</div><div class="line">		<span class="attr">database</span>: <span class="string">'mongodb://localhost/express-todo'</span>,</div><div class="line">		<span class="attr">port</span>: process.env.PORT || <span class="number">3000</span></div><div class="line">	&#125;,</div><div class="line">	<span class="attr">production</span>: &#123;</div><div class="line">		<span class="attr">rootPath</span>: rootPath,</div><div class="line">		<span class="attr">database</span>: <span class="string">''</span>,</div><div class="line">		<span class="attr">port</span>: process.env.PORT || <span class="number">80</span></div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>Next up I moved the express config into a file called <code>config.js</code> in the config directory:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="keyword">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> logger = <span class="keyword">require</span>(<span class="string">'morgan'</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="keyword">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> cookieParser = <span class="keyword">require</span>(<span class="string">'cookie-parser'</span>);</div><div class="line"><span class="keyword">var</span> bodyParser = <span class="keyword">require</span>(<span class="string">'body-parser'</span>);</div><div class="line"><span class="keyword">var</span> favicon = <span class="keyword">require</span>(<span class="string">'serve-favicon'</span>);</div><div class="line"></div><div class="line">module.exports = <span class="function"><span class="keyword">function</span><span class="params">(app, envConfig)</span></span>&#123;</div><div class="line">	<span class="comment">// view engine setup</span></div><div class="line">	app.set(<span class="string">'views'</span>, path.join(envConfig.rootPath, <span class="string">'views'</span>));</div><div class="line">	app.set(<span class="string">'view engine'</span>, <span class="string">'jade'</span>);</div><div class="line"></div><div class="line">	<span class="comment">//app.use(favicon(envConfig.rootPath + '/public/favicon.ico'));</span></div><div class="line">	app.<span class="keyword">use</span>(logger(<span class="string">'dev'</span>));</div><div class="line">	app.<span class="keyword">use</span>(bodyParser.json());</div><div class="line">	app.<span class="keyword">use</span>(bodyParser.urlencoded());</div><div class="line">	app.<span class="keyword">use</span>(cookieParser());</div><div class="line">	<span class="comment">// telling Express to serve static objects from the /public/ dir, but make it seem like the top level</span></div><div class="line">	app.<span class="keyword">use</span>(express.<span class="keyword">static</span>(path.join(envConfig.rootPath, <span class="string">'public'</span>)));</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>Then moved the database connection login into <code>database.js</code> in the config folder:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">envConfig</span>)</span>&#123;</div><div class="line">	<span class="comment">// register models</span></div><div class="line">	<span class="built_in">require</span>(<span class="string">'./models/Todo'</span>);</div><div class="line"></div><div class="line">	<span class="comment">// connect to database</span></div><div class="line">	mongoose.connect(envConfig.database, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'connected to database!'</span>)</div><div class="line">	&#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>Then moved all the routes into <code>routes.js</code> also in the config folder:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">app</span>)</span>&#123;</div><div class="line">	<span class="comment">// register route controllers</span></div><div class="line">	<span class="keyword">var</span> main = <span class="built_in">require</span>(<span class="string">'../routes/main'</span>);</div><div class="line">	<span class="keyword">var</span> todo = <span class="built_in">require</span>(<span class="string">'../routes/todo'</span>);</div><div class="line">	<span class="keyword">var</span> todoRouter = express.Router();</div><div class="line">	app.use(<span class="string">'/todos'</span>, todoRouter);</div><div class="line"></div><div class="line">	app.get(<span class="string">'/'</span>, main.index);</div><div class="line">	todoRouter.get(<span class="string">'/'</span>, todo.all);</div><div class="line">	todoRouter.get(<span class="string">'/:id'</span>, todo.viewOne);</div><div class="line">	todoRouter.post(<span class="string">'/create'</span>, todo.create);</div><div class="line">	todoRouter.post(<span class="string">'/destroy/:id'</span>, todo.destroy);</div><div class="line">	todoRouter.post(<span class="string">'/edit/:id'</span>, todo.edit);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>Check that everything works locally. Also if anyone has tips for a more elegant way to manage environments in express apps let me know</p>
<h3 id="Deploy-to-Heroku"><a href="#Deploy-to-Heroku" class="headerlink" title="Deploy to Heroku"></a>Deploy to Heroku</h3><p>We’re going to use heroku and git for hosting and deploying our node.js app. First create a <code>.gitignore</code> file in the root and include node_modules:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">node_modules/</div></pre></td></tr></table></figure>
<p>This will ignore checking in npm stuff. Heroku will do that anyways. Next add a git file, create one and add your work.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> git init</span></div><div class="line"><span class="meta">$</span><span class="bash"> git add -A</span></div><div class="line"><span class="meta">$</span><span class="bash"> git commit -m <span class="string">'initial commit'</span></span></div></pre></td></tr></table></figure>
<p>Next up we’re going to create a new application using heroku’s command line tool.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> heroku create</span></div></pre></td></tr></table></figure></p>
<p>This will give your app some nonsensical placeholder name. To change it follow this syntax:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> heroku apps:rename newname</span></div></pre></td></tr></table></figure>
<p>Next add a Procfile to your app. So in the root of your project (where server.js is) add a file named <code>Procfile</code>. In there write:</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">web: <span class="keyword">node</span> <span class="title">server</span>.js</div></pre></td></tr></table></figure>
<p>This declares that there’s a web process and to start it use the node server command. </p>
<p>Next set the environment to “production”<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ heroku config:<span class="builtin-name">set</span> <span class="attribute">NODE_ENV</span>=production</div></pre></td></tr></table></figure></p>
<p>This will use the production config object we defined in <code>config/env.js</code>. Next we’re going to update the database key in that object. Head over to <a href="https://mongolab.com/" target="_blank" rel="external">MongoLab</a> and create a database. We’re going to connect to this database via a URI. There’s also a <a href="https://addons.heroku.com/mongolab" target="_blank" rel="external">heroku addon</a> you can use but it requires a credit card.</p>
<p>Update the production config object so it looks similar to this:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">production</span>: &#123;</div><div class="line">		<span class="attribute">rootPath</span>: rootPath,</div><div class="line">		database: <span class="string">'mongodb://jasonshark:multivision@ds037478.mongolab.com:37478/multivision'</span>,</div><div class="line">		port: process.env.PORT || <span class="number">80</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Finally deploy the app to heroku:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> git push heroku master</span></div></pre></td></tr></table></figure>
<p>Check out the <a href="http://express-mongo-jade-todo.herokuapp.com" target="_blank" rel="external">live demo</a> and <a href="https://github.com/jasonshark/express-todo" target="_blank" rel="external">source code</a></p>

	</div>
</div>
	
</body>
</html>